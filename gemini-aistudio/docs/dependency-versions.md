# ä¾èµ–ç‰ˆæœ¬è¯´æ˜Ž

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜Žäº†é¡¹ç›®çš„ Python ç‰ˆæœ¬è¦æ±‚ã€Poetry ä¾èµ–ç®¡ç†å’Œç‰ˆæœ¬æŽ§åˆ¶ç­–ç•¥ã€‚

## ðŸ“¦ ä¾èµ–ç®¡ç†å·¥å…·

> âš ï¸ **é‡è¦æç¤º**: æœ¬é¡¹ç›®çš„ä¾èµ–å…³ç³»å®Œå…¨ç”± **Poetry** ç®¡ç†ã€‚`pyproject.toml` å’Œ `poetry.lock` æ˜¯ä¾èµ–é…ç½®çš„**å”¯ä¸€äº‹å®žæ¥æº (Single Source of Truth)**ã€‚è¯·å‹¿æ‰‹åŠ¨ç»´æŠ¤ `requirements.txt` æ–‡ä»¶ã€‚

é¡¹ç›®ä½¿ç”¨ **Poetry** è¿›è¡ŒçŽ°ä»£åŒ–çš„ä¾èµ–ç®¡ç†ï¼Œç›¸æ¯”ä¼ ç»Ÿçš„ `requirements.txt` æä¾›ï¼š

- âœ… **ä¾èµ–è§£æž**: è‡ªåŠ¨è§£å†³ç‰ˆæœ¬å†²çª
- âœ… **é”å®šæ–‡ä»¶**: `poetry.lock` ç¡®ä¿çŽ¯å¢ƒä¸€è‡´æ€§
- âœ… **è™šæ‹ŸçŽ¯å¢ƒ**: è‡ªåŠ¨åˆ›å»ºå’Œç®¡ç†è™šæ‹ŸçŽ¯å¢ƒ
- âœ… **ä¾èµ–åˆ†ç»„**: åŒºåˆ†ç”Ÿäº§ä¾èµ–å’Œå¼€å‘ä¾èµ–
- âœ… **è¯­ä¹‰åŒ–ç‰ˆæœ¬**: æ›´ç²¾ç¡®çš„ç‰ˆæœ¬æŽ§åˆ¶
- âœ… **æž„å»ºç³»ç»Ÿ**: å†…ç½®æ‰“åŒ…å’Œå‘å¸ƒåŠŸèƒ½

## ðŸ Python ç‰ˆæœ¬è¦æ±‚

### Poetry é…ç½®

```toml
[tool.poetry.dependencies]
python = ">=3.9,<4.0"
```

### æŽ¨èé…ç½®

- **ç”Ÿäº§çŽ¯å¢ƒ**: Python 3.10+ æˆ– 3.11+ (æœ€ä½³æ€§èƒ½å’Œç¨³å®šæ€§)
- **å¼€å‘çŽ¯å¢ƒ**: Python 3.11+ æˆ– 3.12+ (èŽ·å¾—æœ€ä½³å¼€å‘ä½“éªŒ)
- **æœ€ä½Žè¦æ±‚**: Python 3.9 (åŸºç¡€åŠŸèƒ½æ”¯æŒ)

### ç‰ˆæœ¬å…¼å®¹æ€§çŸ©é˜µ

| Pythonç‰ˆæœ¬ | æ”¯æŒçŠ¶æ€    | æŽ¨èç¨‹åº¦ | ä¸»è¦ç‰¹æ€§       | è¯´æ˜Ž                       |
| ---------- | ----------- | -------- | -------------- | -------------------------- |
| 3.8        | âŒ ä¸æ”¯æŒ   | ä¸æŽ¨è   | -              | ç¼ºå°‘å¿…è¦çš„ç±»åž‹æ³¨è§£ç‰¹æ€§     |
| 3.9        | âœ… å®Œå…¨æ”¯æŒ | å¯ç”¨     | åŸºç¡€åŠŸèƒ½       | æœ€ä½Žæ”¯æŒç‰ˆæœ¬ï¼Œæ‰€æœ‰åŠŸèƒ½æ­£å¸¸ |
| 3.10       | âœ… å®Œå…¨æ”¯æŒ | æŽ¨è     | ç»“æž„åŒ–æ¨¡å¼åŒ¹é… | Docker é»˜è®¤ç‰ˆæœ¬ï¼Œç¨³å®šå¯é   |
| 3.11       | âœ… å®Œå…¨æ”¯æŒ | å¼ºçƒˆæŽ¨è | æ€§èƒ½ä¼˜åŒ–       | æ˜¾è‘—æ€§èƒ½æå‡ï¼Œç±»åž‹æç¤ºå¢žå¼º |
| 3.12       | âœ… å®Œå…¨æ”¯æŒ | æŽ¨è     | æ›´å¿«å¯åŠ¨       | æ›´å¿«å¯åŠ¨æ—¶é—´ï¼Œæœ€æ–°ç¨³å®šç‰¹æ€§ |
| 3.13       | âœ… å®Œå…¨æ”¯æŒ | å¯ç”¨     | æœ€æ–°ç‰¹æ€§       | æœ€æ–°ç‰ˆæœ¬ï¼Œå¼€å‘çŽ¯å¢ƒæŽ¨è     |

## ðŸ“‹ Poetry ä¾èµ–é…ç½®

### pyproject.toml ç»“æž„

```toml
[tool.poetry]
name = "aistudioproxyapi"
version = "0.1.0"
package-mode = false

[tool.poetry.dependencies]
# ç”Ÿäº§ä¾èµ–
python = ">=3.9,<4.0"
fastapi = "==0.115.12"
# ... å…¶ä»–ä¾èµ–

[tool.poetry.group.dev.dependencies]
# å¼€å‘ä¾èµ– (å¯é€‰å®‰è£…)
pytest = "^7.0.0"
black = "^23.0.0"
# ... å…¶ä»–å¼€å‘å·¥å…·
```

### ç‰ˆæœ¬çº¦æŸè¯­æ³•

Poetry ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬çº¦æŸï¼š

- `==1.2.3` - ç²¾ç¡®ç‰ˆæœ¬
- `^1.2.3` - å…¼å®¹ç‰ˆæœ¬ (>=1.2.3, <2.0.0)
- `~1.2.3` - è¡¥ä¸ç‰ˆæœ¬ (>=1.2.3, <1.3.0)
- `>=1.2.3,<2.0.0` - ç‰ˆæœ¬èŒƒå›´
- `*` - æœ€æ–°ç‰ˆæœ¬

## ðŸ”§ æ ¸å¿ƒä¾èµ–ç‰ˆæœ¬

### Web æ¡†æž¶ç›¸å…³

```toml
fastapi = "==0.115.12"
pydantic = ">=2.7.1,<3.0.0"
uvicorn = "==0.29.0"
```

**ç‰ˆæœ¬è¯´æ˜Ž**:

- **FastAPI**: ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆæœ¬ï¼ŒåŒ…å«æ€§èƒ½ä¼˜åŒ–å’Œæ–°åŠŸèƒ½ï¼ˆå¦‚ Query/Header/Cookie å‚æ•°æ¨¡åž‹æ”¯æŒï¼‰ã€‚
- **Pydantic**: çŽ°ä»£æ•°æ®éªŒè¯åº“ï¼Œä½¿ç”¨ç‰ˆæœ¬èŒƒå›´ç¡®ä¿å…¼å®¹æ€§ã€‚
- **Uvicorn**: é«˜æ€§èƒ½ ASGI æœåŠ¡å™¨ã€‚

### æµè§ˆå™¨è‡ªåŠ¨åŒ–

```toml
playwright = "*"
camoufox = {version = "0.4.11", extras = ["geoip"]}
```

**ç‰ˆæœ¬è¯´æ˜Ž**:

- **Playwright**: ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ (`*`)ï¼Œç¡®ä¿æµè§ˆå™¨å…¼å®¹æ€§ã€‚
- **Camoufox**: åæŒ‡çº¹æ£€æµ‹æµè§ˆå™¨ï¼ŒåŒ…å«åœ°ç†ä½ç½®æ•°æ®æ‰©å±•ã€‚

### ç½‘ç»œå’Œå®‰å…¨

```toml
aiohttp = "~=3.9.5"
requests = "==2.31.0"
cryptography = "==42.0.5"
pyjwt = "==2.8.0"
websockets = "==12.0"
aiosocks = "~=0.2.6"
python-socks = "~=2.7.1"
```

**ç‰ˆæœ¬è¯´æ˜Ž**:

- **aiohttp**: å¼‚æ­¥HTTPå®¢æˆ·ç«¯ï¼Œå…è®¸è¡¥ä¸ç‰ˆæœ¬æ›´æ–°ã€‚
- **cryptography**: åŠ å¯†åº“ï¼Œå›ºå®šç‰ˆæœ¬ç¡®ä¿å®‰å…¨æ€§ã€‚
- **websockets**: WebSocket æ”¯æŒã€‚
- **requests**: HTTP å®¢æˆ·ç«¯åº“ã€‚

### ç³»ç»Ÿå·¥å…·

```toml
python-dotenv = "==1.0.1"
httptools = "==0.6.1"
uvloop = {version = "*", markers = "sys_platform != 'win32'"}
Flask = "==3.0.3"
tzdata = "^2025.2"
```

**ç‰ˆæœ¬è¯´æ˜Ž**:

- **uvloop**: ä»…åœ¨éž Windows ç³»ç»Ÿå®‰è£…ï¼Œæ˜¾è‘—æå‡æ€§èƒ½ã€‚
- **httptools**: HTTP è§£æžä¼˜åŒ–ã€‚
- **python-dotenv**: çŽ¯å¢ƒå˜é‡ç®¡ç†ã€‚
- **Flask**: ç”¨äºŽç‰¹å®šåŠŸèƒ½çš„è½»é‡çº§ Web æ¡†æž¶ã€‚
- **tzdata**: æ—¶åŒºæ•°æ®æ”¯æŒã€‚

## ðŸ”„ Poetry ä¾èµ–ç®¡ç†å‘½ä»¤

### åŸºç¡€å‘½ä»¤

```bash
# å®‰è£…æ‰€æœ‰ä¾èµ–
poetry install

# å®‰è£…åŒ…æ‹¬å¼€å‘ä¾èµ–
poetry install --with dev

# æ·»åŠ æ–°ä¾èµ–
poetry add package_name

# æ·»åŠ å¼€å‘ä¾èµ–
poetry add --group dev package_name

# ç§»é™¤ä¾èµ–
poetry remove package_name

# æ›´æ–°ä¾èµ–
poetry update

# æ›´æ–°ç‰¹å®šä¾èµ–
poetry update package_name

# æŸ¥çœ‹ä¾èµ–æ ‘
poetry show --tree

# å¯¼å‡º requirements.txt (ä»…ç”¨äºŽæž„å»º/å…¼å®¹æ€§ï¼Œå‹¿æ‰‹åŠ¨ç¼–è¾‘)
poetry export -f requirements.txt --output requirements.txt
```

### é”å®šæ–‡ä»¶ç®¡ç†

```bash
# æ›´æ–°é”å®šæ–‡ä»¶
poetry lock

# ä¸æ›´æ–°é”å®šæ–‡ä»¶çš„æƒ…å†µä¸‹å®‰è£…
poetry install --no-update

# æ£€æŸ¥é”å®šæ–‡ä»¶æ˜¯å¦æœ€æ–°
poetry check
```

## ðŸ“Š ä¾èµ–æ›´æ–°ç­–ç•¥

### è‡ªåŠ¨æ›´æ–° (ä½¿ç”¨ ~ ç‰ˆæœ¬èŒƒå›´)

- `aiohttp~=3.9.5` - å…è®¸è¡¥ä¸ç‰ˆæœ¬æ›´æ–° (3.9.5 â†’ 3.9.x)
- `aiosocks~=0.2.6` - å…è®¸è¡¥ä¸ç‰ˆæœ¬æ›´æ–° (0.2.6 â†’ 0.2.x)
- `python-socks~=2.7.1` - å…è®¸è¡¥ä¸ç‰ˆæœ¬æ›´æ–° (2.7.1 â†’ 2.7.x)

### å›ºå®šç‰ˆæœ¬ (ä½¿ç”¨ == ç²¾ç¡®ç‰ˆæœ¬)

- æ ¸å¿ƒæ¡†æž¶ç»„ä»¶ (FastAPI, Uvicorn, python-dotenv)
- å®‰å…¨ç›¸å…³åº“ (cryptography, pyjwt, requests)
- ç¨³å®šæ€§è¦æ±‚é«˜çš„ç»„ä»¶ (websockets, httptools)

### å…¼å®¹ç‰ˆæœ¬ (ä½¿ç”¨ç‰ˆæœ¬èŒƒå›´)

- `pydantic>=2.7.1,<3.0.0` - ä¸»ç‰ˆæœ¬å†…å…¼å®¹æ›´æ–°

### æœ€æ–°ç‰ˆæœ¬ (ä½¿ç”¨ \* æˆ–æ— é™åˆ¶)

- `playwright = "*"` - æµè§ˆå™¨è‡ªåŠ¨åŒ–ï¼Œéœ€è¦æœ€æ–°åŠŸèƒ½
- `uvloop = "*"` - æ€§èƒ½ä¼˜åŒ–åº“ï¼ŒæŒç»­æ›´æ–°

## ðŸ’¡ å‡çº§æ³¨æ„äº‹é¡¹

- **æµ‹è¯•éªŒè¯**: åœ¨å‡çº§ä¾èµ–åŽï¼ŒåŠ¡å¿…åœ¨å¼€å‘çŽ¯å¢ƒä¸­è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶ã€‚
- **Breaking Changes**: å…³æ³¨ä¸»è¦æ¡†æž¶ï¼ˆå¦‚ FastAPI, Pydanticï¼‰çš„ç‰ˆæœ¬æ›´æ–°æ—¥å¿—ï¼Œæ³¨æ„æ½œåœ¨çš„ç ´åæ€§å˜æ›´ã€‚
- **å®‰å…¨æ›´æ–°**: å®šæœŸæ£€æŸ¥ä¾èµ–çš„å®‰å…¨æ¼æ´žæ›´æ–°ã€‚

## çŽ¯å¢ƒç‰¹å®šé…ç½®

### Docker çŽ¯å¢ƒ

- **åŸºç¡€é•œåƒ**: `python:3.10-slim-bookworm`
- **ç³»ç»Ÿä¾èµ–**: è‡ªåŠ¨å®‰è£…æµè§ˆå™¨è¿è¡Œæ—¶ä¾èµ–
- **Pythonç‰ˆæœ¬**: å›ºå®šä¸º 3.10 (å®¹å™¨å†…)

### å¼€å‘çŽ¯å¢ƒ

- **æŽ¨è**: Python 3.11+
- **è™šæ‹ŸçŽ¯å¢ƒ**: å¼ºçƒˆæŽ¨èä½¿ç”¨ venv æˆ– conda
- **IDEæ”¯æŒ**: é…ç½®äº† pyrightconfig.json (Python 3.13)

### ç”Ÿäº§çŽ¯å¢ƒ

- **æŽ¨è**: Python 3.10 æˆ– 3.11
- **ç¨³å®šæ€§**: ä½¿ç”¨å›ºå®šç‰ˆæœ¬ä¾èµ–
- **ç›‘æŽ§**: å®šæœŸæ£€æŸ¥ä¾èµ–å®‰å…¨æ›´æ–°

## æ•…éšœæŽ’é™¤

### å¸¸è§ç‰ˆæœ¬å†²çª

1. **Python 3.8 å…¼å®¹æ€§é—®é¢˜**
   - å‡çº§åˆ° Python 3.9+
   - æ£€æŸ¥ç±»åž‹æç¤ºè¯­æ³•å…¼å®¹æ€§

2. **ä¾èµ–ç‰ˆæœ¬å†²çª**
   - ä½¿ç”¨è™šæ‹ŸçŽ¯å¢ƒéš”ç¦»
   - æ¸…ç† pip ç¼“å­˜: `pip cache purge`

3. **ç³»ç»Ÿä¾èµ–ç¼ºå¤±**
   - Linux: å®‰è£… `xvfb` ç”¨äºŽè™šæ‹Ÿæ˜¾ç¤º
   - è¿è¡Œ `playwright install-deps`

### ç‰ˆæœ¬æ£€æŸ¥å‘½ä»¤

```bash
# æ£€æŸ¥ Python ç‰ˆæœ¬
python --version

# æ£€æŸ¥å·²å®‰è£…åŒ…ç‰ˆæœ¬
pip list

# æ£€æŸ¥è¿‡æ—¶çš„åŒ…
pip list --outdated

# æ£€æŸ¥ç‰¹å®šåŒ…ä¿¡æ¯
pip show fastapi
```
