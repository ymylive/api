# 流式处理模式详解

本文档详细介绍 AI Studio Proxy API 的三层流式响应获取机制，以及请求队列和并发处理逻辑。

## 🔄 三层响应获取机制概览

项目实现了三层响应获取机制，确保高可用性和最佳性能：

```
请求 → 第一层: 集成流式代理 (True Streaming) → 第二层: 外部Helper服务 → 第三层: Playwright页面交互 (Pseudo-Streaming)
```

### 工作原理

1. **优先级处理**: 按层级顺序尝试获取响应
2. **自动降级**: 上层失败时自动降级到下层
3. **性能优化**: 优先使用高性能方案
4. **完整后备**: 确保在任何情况下都能获取响应

## 🚀 第一层: 集成流式代理 (Standard Streaming)

### 概述

集成流式代理是默认启用的高性能响应获取方案，提供**真正的流式响应 (True Streaming)**。

### 技术特点

- **独立进程**: 运行在独立的进程中，不影响主服务
- **直接转发**: 直接转发请求到 AI Studio，减少中间环节
- **实时传输**: 原生支持 SSE (Server-Sent Events)，Token 实时生成并传输
- **高性能**: 最小化延迟 (TTFT - Time To First Token)，最大化吞吐量

### 配置方式

#### .env 文件配置 (推荐)

```env
# 启用集成流式代理
STREAM_PORT=3120

# 禁用集成流式代理
STREAM_PORT=0
```

### 适用场景

- **日常使用**: 提供最佳性能体验
- **生产环境**: 稳定可靠的生产部署
- **流式应用**: 需要实时响应的应用

## 🔧 第二层: 外部 Helper 服务

### 概述

外部 Helper 服务是可选的备用方案，当集成流式代理不可用时启用。

### 技术特点

- **外部服务**: 独立部署的外部服务
- **认证依赖**: 需要有效的认证文件
- **备用方案**: 作为流式代理的备用

### 配置方式

```env
# 配置 Helper 服务端点
GUI_DEFAULT_HELPER_ENDPOINT=http://your-helper-service:port
```

## 🎭 第三层: Playwright 页面交互 (Pseudo-Streaming)

### 概述

Playwright 页面交互是最终的后备方案。当流式代理不可用时，系统会控制浏览器在页面上生成完整响应，然后模拟流式效果返回给客户端。

### "伪流式" (Pseudo-Streaming) 机制

在此模式下，响应**不是**实时传输的：

1. 系统等待 AI Studio 网页完全生成回复。
2. 获取完整的文本内容。
3. 将完整内容按字符块切割，快速模拟 SSE 事件发送给客户端。

**注意**: 这意味着客户端会感觉到较高的“首字延迟” (Time To First Token)，因为必须等待整个回复生成完毕才能开始接收数据。

### 技术特点

- **浏览器自动化**: 使用 Camoufox 浏览器模拟用户操作
- **完整参数支持**: 支持所有 AI Studio 参数 (`temperature`, `top_p` 等)
- **最终后备**: 确保在任何情况下都能工作

### 适用场景

- **调试模式**: 开发和调试时使用
- **参数精确控制**: 需要精确控制所有参数
- **故障排除**: 当其他方式都失败时的最终方案

## 🚦 请求队列与并发控制

为了保证浏览器自动化操作的稳定性，系统采用了严格的串行处理机制。

### 1. 串行请求队列 (Sequential Queue)

由于浏览器页面（Page Instance）是单例的，且 DOM 操作具有状态依赖性，所有请求（无论是否流式）都会进入一个全局 FIFO 队列。

- **机制**: `api_utils/queue_worker.py` 维护一个 `request_queue`。
- **锁**: 使用 `processing_lock` 确保同一时间只有一个请求在操作浏览器或通过代理发送数据。

### 2. 智能延迟机制 (Smart Delay)

为了防止在连续快速发送流式请求时触发 AI Studio 的风控或导致浏览器状态异常，系统实现了智能延迟机制。

- **逻辑**:
  - 如果上一个请求是流式请求，且当前请求也是流式请求。
  - 且两个请求的间隔时间小于 1 秒。
  - 系统会自动插入 `0.5s - 1.0s` 的延迟。
- **目的**: 模拟人类操作节奏，提高连续对话的稳定性。

### 3. 资源清理与锁释放

- **自动清理**: 每个请求处理完成后，Worker 会自动清理流式队列和聊天历史（如果需要）。
- **超时保护**: 结合内部超时机制，防止死锁导致队列阻塞。

## ⚙️ 模式选择建议

| 模式             | 类型             | 延迟 (TTFT)       | 吞吐量 | 稳定性 | 适用场景            |
| ---------------- | ---------------- | ----------------- | ------ | ------ | ------------------- |
| **集成流式代理** | True Streaming   | 最低              | 最高   | 最高   | **生产环境 (推荐)** |
| **Helper 服务**  | 取决于实现       | 中等              | 中等   | 中等   | 特殊网络环境        |
| **Playwright**   | Pseudo-Streaming | 最高 (需等待生成) | 最低   | 中等   | 调试、参数测试      |

### 故障排除

#### 为什么流式响应感觉有延迟？

- **检查模式**: 确认是否降级到了 Playwright 模式（伪流式）。如果是，这是正常现象，因为需要等待完整生成。
- **检查队列**: 如果有多个并发请求，后续请求必须等待前序请求完成。
- **智能延迟**: 连续发送请求时，系统可能会自动引入短暂延迟。
